---
title: "WL2_Spatial_Variation"
author: "Brandie QC"
date: "`r Sys.Date()`"
output: 
  html_document: 
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Evaluating the phenotypic spatial variation (across beds) at WL2

Purpose: See if we could take advantage of the natural variation at WL2 for the 2026 planting

-   Note: There are some packages in R for autocorrelation


-   One option would be to put out more ibuttons to get a more fine-scale estimate of temperature variation that we could relate to our fitness metrics

    -   Do we want to plant in bed A to capture more mortality and variation? - Depends on how much variation temperature explains in our data

## Load Libraries

```{r}
library(tidyverse)
library(viridis)
library(brms)
library(zoo) #rollmean function
library(lmerTest)
library(MuMIn) #for calculated R^2 of mixed effects models 

sem <- function(x, na.rm=FALSE) {           #for calculating standard error
  sd(x,na.rm=na.rm)/sqrt(length(na.omit(x)))
} 
```

## Load Fitness Data

```{r}
wl2_est <- read_csv("../output/WL2_Traits/WL2_Establishment.csv") %>% select(block:rep, Establishment) %>% 
  mutate(bed.col=if_else(bed.col=="A -", "A", bed.col))

y1_surv <- read_csv("../output/WL2_Traits/WL2_Y1Surv.csv") %>% 
  left_join(wl2_est) %>% 
  select(block, bed:bed.col, Genotype:rep, Y1Surv=Survival) 

wintersurv <- read_csv("../output/WL2_Traits/WL2_WinterSurv_2324.csv") %>% 
  rename(bed.row=`bed- row`, bed.col=`bed- col`) %>% 
  select(block, bed:bed.col, Genotype:rep, WinterSurv)

repsurvy2 <- read_csv("../output/WL2_Traits/WL2_Surv_to_Rep_Y2_2324.csv") %>% 
  select(block, bed:col, Genotype, pop:rep, SurvtoRep_y2)

fruitsy2 <- read_csv("../output/WL2_Traits/WL2_Fruits_Y2_2324.csv") %>% 
  select(block, bed:col, Genotype, pop:rep, fruits)

probfruit <- read_csv("../output/WL2_Traits/WL2_ProbFruits_Y2_2324.csv") %>% 
  select(block, bed:col, Genotype, pop:rep, ProbFruits)

totfruit <- read_csv("../output/WL2_Traits/WL2_TotalRepOutput.csv") %>% 
  select(block:rep, Total_Fitness)
```

## Load Size (Height and herbivory 2 months post transplant; stem diameter end of first year)

```{r}
WL2_twomonths_size <- read_csv("../input/WL2_Data/CorrectedCSVs/WL2_size_survey_20230913_corrected.csv", 
                               na = c("", "NA", "-", "N/A")) %>% 
  filter(!is.na(pop)) %>% 
  rename(parent.pop=pop) %>% 
  mutate(parent.pop= str_replace(parent.pop, ".*VTR.*", "LVTR1")) %>% 
  unite(BedLoc, bed:bed.col, sep="_", remove = FALSE) %>% 
  filter(BedLoc!="K_5_C", BedLoc!="B_32_A", BedLoc!="C_4_D", BedLoc!="C_5_D") %>% 
  mutate(mf=as.double(mf), rep=as.double(rep)) %>% 
  unite(Genotype, parent.pop:rep, sep="_", remove = FALSE) %>% 
  filter(!str_detect(Genotype, ".*buff*")) %>% 
  select(block:height.cm, herbiv.y.n)

wl2_anncensus <- read_csv("../input/WL2_Data/CorrectedCSVs/WL2_annual_census_20231027_corrected.csv") %>% 
  select(block, bed, bed.row=`bed-row`, bed.col=`bed-col`, pop:diam.mm) %>% 
  filter(!is.na(pop)) %>% 
  rename(parent.pop=pop) %>% 
  mutate(parent.pop= str_replace(parent.pop, ".*VTR.*", "LVTR1")) %>% 
  unite(BedLoc, bed:bed.col, sep="_", remove = FALSE) %>% 
  filter(BedLoc!="K_5_C", BedLoc!="B_32_A", BedLoc!="C_4_D", BedLoc!="C_5_D") %>% 
  mutate(mf=as.double(mf), rep=as.double(rep)) %>% 
  unite(Genotype, parent.pop:rep, sep="_", remove = FALSE) %>% 
  filter(!str_detect(Genotype, ".*buff*"))
```

## Read in soil temp

```{r}
temp_2023 <- read_csv("../input/WL2_Data/WL2_2022_2023_iButton_Data_Corrected.csv") %>%
  select(-`...3`) %>%
  mutate(Date_Time = mdy_hm(Date_Time)) %>%
  filter(Date_Time > ymd("2023-07-06"))
head(temp_2023)
unique(temp_2023$Bed) #only have Bed A and D
#2 at each end of bed A and 3 in bed D ends and middle

temp_2024 <- read_csv("../input/WL2_Data/WL2_2024_iButton_Data_Corrected.csv")
head(temp_2024)
unique(temp_2024$Bed) #have data for all beds 
```

## Box Plots

```{r}
wl2_est %>% 
  ggplot(aes(x=bed, y=Establishment)) +
  geom_boxplot()

y1_surv %>% 
  ggplot(aes(x=bed, y=Y1Surv)) +
  geom_boxplot()

wintersurv %>% 
  ggplot(aes(x=bed, y=WinterSurv)) +
  geom_boxplot()

repsurvy2 %>% 
  ggplot(aes(x=bed, y=SurvtoRep_y2)) +
  geom_boxplot()

fruitsy2 %>% 
  ggplot(aes(x=bed, y=fruits)) +
  geom_boxplot()

probfruit %>% 
  ggplot(aes(x=bed, y=ProbFruits)) +
  geom_boxplot()

totfruit %>% 
  ggplot(aes(x=bed, y=Total_Fitness)) +
  geom_boxplot()

WL2_twomonths_size %>% 
  ggplot(aes(x=bed, y=height.cm)) +
  geom_boxplot()

WL2_twomonths_size %>% 
  mutate(herbiv.bin = if_else(herbiv.y.n=="Y", 1, 0)) %>% 
  ggplot(aes(x=bed, y=herbiv.bin)) +
  geom_boxplot()

wl2_anncensus %>% 
  ggplot(aes(x=bed, y=diam.mm)) +
  geom_boxplot()

temp_2023 %>% 
  ggplot(aes(x=Bed, y=SoilTemp)) +
  geom_boxplot()

temp_2024 %>% 
  ggplot(aes(x=Bed, y=SoilTemp)) +
  geom_boxplot()
```

## Summaries

```{r}
wl2_est_summary <- wl2_est %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(Establishment, na.rm=TRUE), semSurv=sem(Establishment, na.rm=TRUE))

y1surv_summary <- y1_surv %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(Y1Surv, na.rm=TRUE), semSurv=sem(Y1Surv, na.rm=TRUE))

wintersurv_summary <- wintersurv %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(WinterSurv, na.rm=TRUE), semSurv=sem(WinterSurv, na.rm=TRUE))

repsurvy2_summary <- repsurvy2 %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(SurvtoRep_y2, na.rm=TRUE), semSurv=sem(SurvtoRep_y2, na.rm=TRUE))

fruitsy2_summary <- fruitsy2 %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(fruits, na.rm=TRUE), semSurv=sem(fruits, na.rm=TRUE))

probfruit_summary <- probfruit %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(ProbFruits, na.rm=TRUE), semSurv=sem(ProbFruits, na.rm=TRUE))

totfruit_summary <- totfruit %>% 
  group_by(bed) %>% 
  summarise(meanSurv=mean(Total_Fitness, na.rm=TRUE), semSurv=sem(Total_Fitness, na.rm=TRUE))

height_summary <- WL2_twomonths_size %>% 
  group_by(bed) %>% 
  summarise(meanHeight=mean(height.cm, na.rm=TRUE), semHeight=sem(height.cm, na.rm=TRUE))

herbiv_summary <- WL2_twomonths_size %>% 
  mutate(herbiv.bin = if_else(herbiv.y.n=="Y", 1, 0)) %>% 
  group_by(bed) %>% 
  summarise(meanHerb=mean(herbiv.bin, na.rm=TRUE), semHerb=sem(herbiv.bin, na.rm = TRUE))

diam_summary <- wl2_anncensus %>% 
  group_by(bed) %>% 
  summarise(meanDiam=mean(diam.mm, na.rm=TRUE), semDiam=sem(diam.mm, na.rm=TRUE))
```

```{r}
temp_2023_daily_summary <- temp_2023 %>%
  mutate(Date=as.Date(Date_Time)) %>%
  group_by(Bed, Date) %>% #summarize hourly data by date
  summarize(
    min_temp_d = min(SoilTemp),
    max_temp_d = max(SoilTemp),
    mean_temp_d = mean(SoilTemp),
    diurnal_temp_d = max_temp_d - min_temp_d
  )
temp_2023_beds_summary <- temp_2023_daily_summary %>% 
  group_by(Bed) %>% 
  summarise(AvgMin=mean(min_temp_d), semMin=sem(min_temp_d),
            AvgMax=mean(max_temp_d), semMax=sem(max_temp_d),
            AvgTemp=mean(mean_temp_d), semMean=sem(mean_temp_d),
            AvgDiurnal=mean(diurnal_temp_d), semDiurnal=sem(diurnal_temp_d))
temp_2023_beds_summary

temp_2024_daily_summary <- temp_2024 %>%
  mutate(Date=as.Date(Date_Time)) %>%
  group_by(Bed, Date) %>% #summarize hourly data by date
  summarize(
    min_temp_d = min(SoilTemp),
    max_temp_d = max(SoilTemp),
    mean_temp_d = mean(SoilTemp),
    diurnal_temp_d = max_temp_d - min_temp_d
  )
temp_2024_beds_summary <- temp_2024_daily_summary %>% 
  group_by(Bed) %>% 
  summarise(AvgMin=mean(min_temp_d), semMin=sem(min_temp_d),
            AvgMax=mean(max_temp_d), semMax=sem(max_temp_d),
            AvgTemp=mean(mean_temp_d), semMean=sem(mean_temp_d),
            AvgDiurnal=mean(diurnal_temp_d), semDiurnal=sem(diurnal_temp_d))
temp_2024_beds_summary
```

## Bar Plots

```{r}
wl2_est_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Establishment") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Est.png", width = 12, height = 8, units = "in")

y1surv_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Y1 Surv") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Y1Surv.png", width = 12, height = 8, units = "in")

wintersurv_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Winter Surv") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_WinterSurv.png", width = 12, height = 8, units = "in")

repsurvy2_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Surv to Bud Y2") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Y2RepSurv.png", width = 12, height = 8, units = "in")

fruitsy2_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Fruits Y2") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Y2Fruits.png", width = 12, height = 8, units = "in")

probfruit_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Prob. Fruit") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_ProbRep.png", width = 12, height = 8, units = "in")

totfruit_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanSurv), y=meanSurv)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanSurv-semSurv,ymax=meanSurv+semSurv),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Total Fruit") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_TotRep.png", width = 12, height = 8, units = "in")

height_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanHeight), y=meanHeight)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanHeight-semHeight,ymax=meanHeight+semHeight),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Height (cm)", title = "Two Months Post-Transplant") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Height.png", width = 12, height = 8, units = "in")

herbiv_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanHerb), y=meanHerb)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanHerb-semHerb,ymax=meanHerb+semHerb),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Prob of Herbivory", title = "Two Months Post-Transplant") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Herbiv.png", width = 12, height = 8, units = "in")

diam_summary %>% 
  ggplot(aes(x=fct_reorder(bed, meanDiam), y=meanDiam)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=meanDiam-semDiam,ymax=meanDiam+semDiam),width=.2, position = 
                  position_dodge(0.75)) +
  theme_classic() +
  labs(x="Bed", y="Stem Diameter (mm)") +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/Beds_Diam.png", width = 12, height = 8, units = "in")
```

## Spatial Plots Prep

x = beds + cols y = row

```{r}
bed_col_info <- wl2_est %>% 
  select(bed, bed.col) %>% 
  distinct() %>% 
  mutate(x_pos = if_else(bed.col=="A", 1,
                         if_else(bed.col=="B", 2, 
                                 if_else(bed.col=="C", 3, 4)))) %>% 
  mutate(x_pos=if_else(bed=="B", x_pos+6,
                       if_else(bed=="C", x_pos+12,
                               if_else(bed=="D", x_pos+18,
                                       if_else(bed=="E", x_pos+24,
                                               if_else(bed=="F", x_pos+30,
                                                       if_else(bed=="G", x_pos+36,
                                                               if_else(bed=="H", x_pos+42, 
                                                                       if_else(bed=="I", x_pos+48,
                                                                               if_else(bed=="J", x_pos+54, 
                                                                                       if_else(bed=="K", x_pos+60, x_pos))))))))))) %>% 
  arrange(bed, bed.col)

bed_col_info

bed_rect <- data.frame( #data frame for bed rectangles 
  xmin = c(1, 7, 13, 19, 25, 31, 37, 43, 49, 55, 61),
  xmax = c(4, 10, 16, 22, 28, 34, 40, 46, 52, 58, 64),
  ymin = 1,
  ymax = c(59, 59, 58, 59, 51, 46, 43, 34, 22, 18, 13)
)
```

## Spatial Plots

```{r}
wl2_est %>% 
  left_join(bed_col_info) %>% 
  mutate(Establishment=as.character(Establishment)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=Establishment)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_manual(values = c("gray", "darkgreen")) + 
  theme_classic() +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/SpatialVar_Est.png", width = 12, height = 8, units = "in")

y1_surv %>% 
  left_join(bed_col_info) %>% 
  mutate(Y1Surv=as.character(Y1Surv)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=Y1Surv)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_manual(values = c("gray", "darkgreen")) + 
  theme_classic() +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/SpatialVar_Y1Surv.png", width = 12, height = 8, units = "in")

wintersurv %>% 
  left_join(bed_col_info) %>% 
  mutate(WinterSurv=as.character(WinterSurv)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=WinterSurv)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_manual(values = c("gray", "darkgreen")) + 
  theme_classic() +
  theme(text=element_text(size=25)) 
ggsave("../output/WL2_Traits/SpatialVar_WinterSurv.png", width = 12, height = 8, units = "in")

repsurvy2 %>% 
  rename(bed.row=row, bed.col=col) %>% 
  left_join(bed_col_info) %>% 
  mutate(SurvtoRep_y2=as.character(SurvtoRep_y2)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=SurvtoRep_y2)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_manual(values = c("gray", "darkgreen")) + 
  geom_rect(data=bed_rect, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), colour = "black", alpha=0, inherit.aes = FALSE) +
  theme_classic()

probfruit %>% 
  rename(bed.row=row, bed.col=col) %>% 
  left_join(bed_col_info) %>% 
  mutate(ProbFruits=as.character(ProbFruits)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=ProbFruits)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_manual(values = c("gray", "darkgreen")) + 
  geom_rect(data=bed_rect, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), colour = "black", alpha=0, inherit.aes = FALSE) +
  theme_classic()

 WL2_twomonths_size %>% 
  mutate(herbiv.bin = if_else(herbiv.y.n=="Y", 1, 0)) %>% 
  left_join(bed_col_info) %>% 
  mutate(herbiv.bin=as.character(herbiv.bin)) %>% 
   filter(!is.na(herbiv.bin)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=herbiv.bin)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_manual(values = c("gray", "darkgreen")) + 
  theme_classic()
```

### Continuous Traits (fruit number and size)

```{r}
fruitsy2 %>% 
  rename(bed.row=row, bed.col=col) %>% 
  left_join(bed_col_info) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=fruits)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_viridis() +
  geom_rect(data=bed_rect, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), colour = "black", alpha=0, inherit.aes = FALSE) +
  theme_classic()

totfruit %>% 
  left_join(bed_col_info) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=Total_Fitness)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_viridis() +
  geom_rect(data=bed_rect, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), colour = "black", alpha=0, inherit.aes = FALSE) +
  theme_classic()

WL2_twomonths_size %>% 
  left_join(bed_col_info) %>% 
  filter(!is.na(height.cm)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=height.cm)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_viridis() +
  theme_classic()

wl2_anncensus %>% 
  left_join(bed_col_info) %>% 
  filter(!is.na(diam.mm)) %>% 
  ggplot(aes(x=x_pos, y=bed.row, colour=diam.mm)) +
  geom_point(size=3) +
  scale_y_reverse() +
  scale_color_viridis() +
  theme_classic()
```

## Temperature Plots

### 2023

```{r}
temp_2023_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgMin), y=AvgMin)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgMin-semMin,ymax=AvgMin+semMin),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Min Temp", title = "WL2 2023")
ggsave("../output/Climate/MinTemp_2023.png", width = 12, height = 8, units = "in")

temp_2023_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgMax), y=AvgMax)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgMax-semMax,ymax=AvgMax+semMax),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Max Temp", title = "WL2 2023")
ggsave("../output/Climate/MaxTemp_2023.png", width = 12, height = 8, units = "in")

temp_2023_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgTemp), y=AvgTemp)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgTemp-semMean,ymax=AvgTemp+semMean),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Mean Temp", title = "WL2 2023")
ggsave("../output/Climate/MeanTemp_2023.png", width = 12, height = 8, units = "in")

temp_2023_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgDiurnal), y=AvgDiurnal)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgDiurnal-semDiurnal,ymax=AvgDiurnal+semDiurnal),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Diurnal Range", title = "WL2 2023")
ggsave("../output/Climate/DiurnalTemp_2023.png", width = 12, height = 8, units = "in")

temp_2023_daily_summary %>% 
  ggplot(aes(x=Date, y=mean_temp_d, group=Bed, colour=Bed)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  theme(text=element_text(size=25)) +
  labs(x="Date", y="Mean Temp", title = "WL2 2023")
ggsave("../output/Climate/MeanTemp_Time_2023.png", width = 12, height = 8, units = "in")
```

### 2024

```{r}
temp_2024_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgMin), y=AvgMin)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgMin-semMin,ymax=AvgMin+semMin),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Min Temp", title = "WL2 2024")
ggsave("../output/Climate/MinTemp_2024.png", width = 12, height = 8, units = "in")

temp_2024_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgMax), y=AvgMax)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgMax-semMax,ymax=AvgMax+semMax),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Max Temp", title = "WL2 2024")
ggsave("../output/Climate/MaxTemp_2024.png", width = 12, height = 8, units = "in")

temp_2024_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgTemp), y=AvgTemp)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgTemp-semMean,ymax=AvgTemp+semMean),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Mean Temp", title = "WL2 2024")
ggsave("../output/Climate/MeanTemp_2024.png", width = 12, height = 8, units = "in")

temp_2024_beds_summary %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgDiurnal), y=AvgDiurnal)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgDiurnal-semDiurnal,ymax=AvgDiurnal+semDiurnal),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Diurnal Range", title = "WL2 2024")
ggsave("../output/Climate/DiurnalTemp_2024.png", width = 12, height = 8, units = "in")

temp_2024_daily_summary %>% 
  ggplot(aes(x=Date, y=mean_temp_d, group=Bed, colour=Bed)) +
  geom_point() +
  geom_line() 

temp_2024_daily_summary %>% 
  filter(Date>"2024-05-01") %>% 
  ggplot(aes(x=Date, y=mean_temp_d, group=Bed, colour=Bed)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  theme(text=element_text(size=25)) +
  labs(x="Date", y="Mean Temp", title = "WL2 2024")
ggsave("../output/Climate/MeanTemp_Time_2024.png", width = 12, height = 8, units = "in")
```

## Winter Temps

-   Check overwinter temps

    -   Good control/sanity check - they should be the same while under the snow
    
```{r}
summary(temp_2024_daily_summary)

temp_2024_daily_summary %>% 
  filter(Date >= "2023-12-01") %>% 
  filter(Date < "2024-05-12") %>% 
  ggplot(aes(x=Date, y=mean_temp_d, group=Bed, colour=Bed)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  theme(text=element_text(size=25)) +
  labs(x="Date", y="Mean Temp", title = "WL2 2024")
ggsave("../output/Climate/MeanTemp_Time_Wint2024.png", width = 12, height = 8, units = "in")

temp_2024_daily_summary %>% 
  filter(Date >= "2023-12-01") %>% 
  filter(Date < "2024-05-12") %>% 
  ggplot(aes(x=Date, y=min_temp_d, group=Bed, colour=Bed)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  theme(text=element_text(size=25)) +
  labs(x="Date", y="Min Temp", title = "WL2 2024")

temp_2024_daily_summary %>% 
  filter(Date >= "2023-12-01") %>% 
  filter(Date < "2024-05-12") %>% 
  ggplot(aes(x=Date, y=max_temp_d, group=Bed, colour=Bed)) +
  geom_point() +
  geom_line() +
  theme_classic() +
  theme(text=element_text(size=25)) +
  labs(x="Date", y="Max Temp", title = "WL2 2024")

winter_temps <- temp_2024_daily_summary %>% 
  filter(Date >= "2023-12-01", Date < "2024-05-12") %>% 
  group_by(Bed) %>% 
  summarise(AvgMin=mean(min_temp_d), semMin=sem(min_temp_d),
            AvgMax=mean(max_temp_d), semMax=sem(max_temp_d),
            AvgTemp=mean(mean_temp_d), semMean=sem(mean_temp_d),
            AvgDiurnal=mean(diurnal_temp_d), semDiurnal=sem(diurnal_temp_d))

winter_temps %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgMin), y=AvgMin)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgMin-semMin,ymax=AvgMin+semMin),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Min Temp", title = "Winter 2023-2024")
ggsave("../output/Climate/MinTemp_Wint2024.png", width = 12, height = 8, units = "in")

winter_temps %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgMax), y=AvgMax)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgMax-semMax,ymax=AvgMax+semMax),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Max Temp", title = "Winter 2023-2024")
ggsave("../output/Climate/MaxTemp_Wint2024.png", width = 12, height = 8, units = "in")

winter_temps %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgTemp), y=AvgTemp)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgTemp-semMean,ymax=AvgTemp+semMean),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Mean Temp", title = "Winter 2023-2024")
ggsave("../output/Climate/MeanTemp_Wint2024.png", width = 12, height = 8, units = "in")

winter_temps %>% 
  ggplot(aes(x=fct_reorder(Bed, AvgDiurnal), y=AvgDiurnal)) +
  geom_col(width = 0.7,position = position_dodge(0.75)) + 
  geom_errorbar(aes(ymin=AvgDiurnal-semDiurnal,ymax=AvgDiurnal+semDiurnal),width=.2, position = 
                  position_dodge(0.75)) +
  theme_minimal() +
  theme(text=element_text(size=25)) +
  labs(x="Bed", y="Diurnal Range", title = "Winter 2023-2024")
ggsave("../output/Climate/DiurnalTemp_Wint2024.png", width = 12, height = 8, units = "in")
```

## Models

### Temp \~ Bed

```{r}
min_temp_2023_model <- lm(min_temp_d ~ Bed*Date, data=temp_2023_daily_summary)
summary(min_temp_2023_model)
min_temp_2024_model <- lm(min_temp_d ~ Bed*Date, data=temp_2024_daily_summary)
summary(min_temp_2024_model)

max_temp_2023_model <- lm(max_temp_d ~ Bed*Date, data=temp_2023_daily_summary)
summary(max_temp_2023_model)
max_temp_2024_model <- lm(max_temp_d ~ Bed*Date, data=temp_2024_daily_summary)
summary(max_temp_2024_model)

mean_temp_2023_model <- lm(mean_temp_d ~ Bed*Date, data=temp_2023_daily_summary)
summary(mean_temp_2023_model)
mean_temp_2024_model <- lm(mean_temp_d ~ Bed*Date, data=temp_2024_daily_summary)
summary(mean_temp_2024_model)

diurnal_temp_2023_model <- lm(diurnal_temp_d ~ Bed*Date, data=temp_2023_daily_summary)
summary(diurnal_temp_2023_model)
diurnal_temp_2024_model <- lm(diurnal_temp_d ~ Bed*Date, data=temp_2024_daily_summary)
summary(diurnal_temp_2024_model)
```

### Example code for spatial autoregression models

<https://paulbuerkner.com/brms/reference/car.html>

```{r, eval=FALSE}
# generate some spatial data
east <- north <- 1:10
Grid <- expand.grid(east, north)
K <- nrow(Grid)

# set up distance and neighbourhood matrices
distance <- as.matrix(dist(Grid))
W <- array(0, c(K, K))
W[distance == 1] <- 1

# generate the covariates and response data
x1 <- rnorm(K)
x2 <- rnorm(K)
theta <- rnorm(K, sd = 0.05)
phi <- rmulti_normal(
  1, mu = rep(0, K), Sigma = 0.4 * exp(-0.1 * distance)
)
eta <- x1 + x2 + phi
prob <- exp(eta) / (1 + exp(eta))
size <- rep(50, K)
y <- rbinom(n = K, size = size, prob = prob)
dat <- data.frame(y, size, x1, x2)

# fit a CAR model
fit <- brm(y | trials(size) ~ x1 + x2 + car(W),
           data = dat, data2 = list(W = W),
           family = binomial())
summary(fit)
#Warning: Using CAR terms without a grouping factor is deprecated. Please use argument 'gr' even if each observation represents its own location.
```

### Fitness - Spatial auto-correlation

```{r, eval=FALSE}
wl2_est_space <- wl2_est %>% 
  left_join(bed_col_info)

# pull out the spatial data
y_pos <- wl2_est_space %>% 
  select(bed.row) %>% 
  distinct() %>% 
  pull(bed.row)
x_pos <- wl2_est_space %>% 
  select(x_pos) %>% 
  distinct()%>% 
  pull(x_pos)
Grid <- expand.grid(x_pos, y_pos)
K <- nrow(Grid)

# set up distance and neighbourhood matrices
distance <- as.matrix(dist(Grid))
W <- array(0, c(K, K))
W[distance == 1] <- 1


# fit a CAR model
est_space_fit <- brm(Establishment~ car(W),
           data = wl2_est_space, data2 = list(W = W),
           family = bernoulli())
summary(est_space_fit)
#Error: Dimensions of 'M' for CAR terms must be equal to the number of observations.
##But M must also be symmetric... our data is not spatially symmetric...
dim(W)
```

### Fitness \~ Bed

```{r}
#Establishment 
est_mod_1 <- glm(Establishment ~ bed, data=wl2_est, family = "binomial")
summary(est_mod_1)

est_mod_2 <- glm(Establishment ~ bed + bed:bed.row, data=wl2_est, family = "binomial")
summary(est_mod_2)
#Interpretation: The coefficients for A:B will represent the differences in est for each row within each bed, relative to the baseline level of bed

#Y1 Surv
y1surv_mod <- glm(Y1Surv ~ bed + bed:bed.row, data=y1_surv, family = "binomial")
summary(y1surv_mod)

#WinterSurv
wintersurv_mod <- glm(WinterSurv ~ bed/bed.row, data=wintersurv, family="binomial")
summary(wintersurv_mod)

#Surv to Bud Y2
repsurvy2_mod <- glm(SurvtoRep_y2 ~ bed/row, data=repsurvy2, family = "binomial")
summary(repsurvy2_mod)

#Fruits Y2 
fruitsy2_mod <- lm(fruits ~ bed/row, data=fruitsy2)
summary(fruitsy2_mod)

#Height
height_mod <- lm(height.cm ~ bed/bed.row, data=WL2_twomonths_size)
summary(height_mod)

#Herbiv
herbiv.bin <- WL2_twomonths_size %>% 
  mutate(herbiv.bin = if_else(herbiv.y.n=="Y", 1, 0))
herb_mod <- glm(herbiv.bin ~ bed/bed.row, data=herbiv.bin, family="binomial")
summary(herb_mod)

#Stem Diameter
diam_mod <- lm(diam.mm ~ bed/bed.row, data=wl2_anncensus)
summary(diam_mod)
```

### Fitness \~ Temp + (1\|bed)

-   Try models with 2024 temperature/TDR data and 2023 establishment

    -   2024 data does at least proxy bed differences

    -   How much variation does temperature explain?
    
```{r}
#establishment - use the avg temp for the first 3 weeks (use Month/Day from 2023, but use 2024 data)
#Finished planting 7/19, 3 weeks later = 8/9
est_temps <- temp_2024_daily_summary %>% 
  filter(Date > "2024-07-19", Date <= "2024-08-09") %>% 
  group_by(Bed) %>% 
  summarise(AvgMin=mean(min_temp_d), semMin=sem(min_temp_d),
            AvgMax=mean(max_temp_d), semMax=sem(max_temp_d),
            AvgTemp=mean(mean_temp_d), semMean=sem(mean_temp_d),
            AvgDiurnal=mean(diurnal_temp_d), semDiurnal=sem(diurnal_temp_d))

wl2_est_temp <- wl2_est %>% 
  left_join(est_temps, by=c("bed" = "Bed"))

est_mod3 <- glmer(Establishment ~ AvgMin + (1|bed), data=wl2_est_temp, family = "binomial")
summary(est_mod3)

est_mod4 <- glmer(Establishment ~ AvgMax + (1|bed), data=wl2_est_temp, family = "binomial")
summary(est_mod4)
r.squaredGLMM(est_mod4)

est_mod5 <- glmer(Establishment ~ AvgTemp + (1|bed), data=wl2_est_temp, family = "binomial")
summary(est_mod5)
anova(est_mod5)
r.squaredGLMM(est_mod5) #calculate r^2
#Marginal R² quantifies the variance explained by the fixed effects alone, whereas conditional R² accounts for the variance explained by both the fixed and random effects together
est_mod5b <- glm(Establishment ~ AvgTemp, data=wl2_est_temp, family = "binomial") #remove random effect 
anova(est_mod5, est_mod5b) #model with random effeccts is the best 

est_mod6 <- glmer(Establishment ~ AvgDiurnal + (1|bed), data=wl2_est_temp, family = "binomial")
summary(est_mod6)

wl2_est_temp %>% 
  ggplot(aes(x=AvgMax, y=Establishment)) +
  geom_point()

wl2_est_temp %>% 
  ggplot(aes(x=AvgTemp, y=Establishment)) +
  geom_point()
```

-   2024 Fruits with 2024 Temps

```{r}
#fruits y2 - use bed means
fruitsy2_temp <- fruitsy2 %>% 
  left_join(temp_2024_beds_summary, by=c("bed" = "Bed"))

fruitsy2_mod2 <- lmer(fruits ~ AvgMin + (1|bed), data=fruitsy2_temp)
summary(fruitsy2_mod2)
fruitsy2_mod3 <- lmer(fruits ~ AvgMax + (1|bed), data=fruitsy2_temp)
summary(fruitsy2_mod3)
fruitsy2_mod4 <- lmer(fruits ~ AvgTemp + (1|bed), data=fruitsy2_temp)
summary(fruitsy2_mod4)
fruitsy2_mod5 <- lmer(fruits ~ AvgDiurnal + (1|bed), data=fruitsy2_temp)
summary(fruitsy2_mod5)
#no sig relats with temp 
```
