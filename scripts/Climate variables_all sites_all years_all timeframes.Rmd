---
title: "Climatevars_all sites_all years_all timeframes"
author: "JR Gremer"
date: "2025-07-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#clear console if needed
#rm(list = ls())
```

# This code compiles and calculates all flint and bioclim variables for each site, year, and timeframe


## Load libraries 
```{r}
library(tidyverse)
library(QBMS) #for function calc_biovars to calculate bioclim variables
```

## Load the pop and location data

```{r}
#pop info
pops_common_garden <- read_csv("../input/WL2_Data/Pops_for_2023_WL2.csv") #pops included in common garden 
pops_common_garden_nonotes <- pops_common_garden %>% select(parent.pop:phylogroup, elevation.group)
yose1 <- tibble(parent.pop="YO1", phylogroup=NA) #Need to add YO1 for JGI
pops_common_garden_jgi <- bind_rows(pops_common_garden_nonotes, yose1)

#extra location info 
pop_loc <- read_csv("../input/Strep_tort_locs.csv")

#need to change YOSE to YO
pop_loc_yo <- pop_loc %>% mutate(parent.pop = str_replace(`Site code`, "YOSE(\\d+)", "YO\\1")) %>% select(Lat, Long, elev_m=`Elevation (m)`, parent.pop)

#merge in location info
pop_elev <- left_join(pops_common_garden_jgi, pop_loc_yo)

#add in common garden sites
sites_loc <- tibble(parent.pop=c("UCD_Garden", "WL2_Garden"), phylogroup=NA, Lat=c("38.53250", "38.82599"), Long=c("-121.78299", "-120.25090"), elev_m=c(16,2020))
pops_gardens_locs <- bind_rows(pop_elev, sites_loc)

#add row names
pops_gardens_locs_rowids <- pops_gardens_locs %>% rowid_to_column() %>% mutate(rowid = as.character(rowid))
```

## Load raw flint data 
```{r}
flint_data1 <- read_csv("../input/Updated_Flint_Climate_Oct2024.csv") #This only goes through Aug 2024
flint_data2 <- read_csv("../input/Updated_Flint_Sept-Dec2024.csv") #Sept-Dec 2024

#merge:
flint_data <- bind_rows(flint_data1, flint_data2)
```

## Convert raw flint into a workable format (original code in "Climate_Shapefile.Rmd")
```{r}
cwd <- flint_data %>% filter(str_detect(DataFileName, "cwd"))
cwd_long <- cwd %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "cwd") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, cwd)

pet <- flint_data %>% filter(str_detect(DataFileName, "pet"))
pet_long <- pet %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "pet") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, pet)

aet <- flint_data %>% 
  filter(str_detect(DataFileName, "aet"))
aet_long <- aet %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "aet") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, aet)

pck <- flint_data %>% filter(str_detect(DataFileName, "pck"))
pck_long <- pck %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "pck") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, pck)

ppt <- flint_data %>% filter(str_detect(DataFileName, "ppt"))
ppt_long <- ppt %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "ppt") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, ppt)

tmn <- flint_data %>% filter(str_detect(DataFileName, "tmn"))
tmn_long <- tmn %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "tmn") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, tmn)

tmx <- flint_data %>% filter(str_detect(DataFileName, "tmx"))
tmx_long <- tmx %>% 
  pivot_longer(!DataFileName, names_to = "rowid", values_to = "tmx") %>% 
  extract(DataFileName, c("year", "month"), "(\\d+)(.*)", convert = TRUE) %>% 
  separate(month, into = c("month", "file_type")) %>% select(rowid, year, month, tmx)

#merge:
flint_long <- full_join(aet_long, cwd_long)
flint_long <- full_join(flint_long, pck_long)
flint_long <- full_join(flint_long, pet_long)
flint_long <- full_join(flint_long, ppt_long)
flint_long <- full_join(flint_long, tmn_long)
flint_long <- full_join(flint_long, tmx_long)

flint_pops <- full_join(pops_gardens_locs_rowids, flint_long) 
#write_csv(flint_pops, "../output/Climate/Flint_AllSites_Dec2024.csv") 
```

### Subset to only the 23 pops plus the garden sites
```{r}
pop_elev_climate <- flint_pops %>% 
  select(parent.pop, elevation.group, elev_m, Lat:Long, year:tmx) %>% 
  mutate(year=as.character(year),
         elevation.group=if_else(parent.pop=="UCD_Garden", "Low", 
                                 if_else(parent.pop=="WL2_Garden", "High", elevation.group))) %>% 
  filter(parent.pop!="YO1") #remove YO1 from the dataset 
#write_csv(pop_elev_climate, "../output/Climate/flint_climate_UCDpops.csv") #this is the file used in "Flint_Growth_Season.Rmd"
```

## Flint Water Year 

 
## load data and identify time frames ##
```{r}
flint_all_year_wtr_yr <- read_csv("../output/Climate/flint_all_year_wtr_yr.csv") %>%
                         mutate(timeframe = case_when(
                                year < 1964 ~ "beforehistoric",
                                year >= 1964 & year < 1994 ~ "historic",
                                year >= 1994 & year <2024 ~ "recent")) %>%
                         mutate(timeframe = as.factor(timeframe), month = as.factor(month)) %>%
                         filter(wtr_yr != 1895, wtr_yr < 2024) %>%#remove years with less than 12 months of data 
                         mutate(months_wtryr = case_when(
                           month == "nov" ~ 1,
                           month == "dec" ~ 2,
                           month == "jan" ~ 3,
                           month == "feb" ~ 4,
                           month == "mar" ~ 5,
                           month == "apr" ~ 6,
                           month == "may" ~ 7, 
                           month == "jun" ~ 8,
                           month == "jul" ~ 9, 
                           month == "aug" ~ 10,
                           month == "sep" ~ 11,
                           month == "oct" ~ 12 ))
summary(flint_all_year_wtr_yr)
#water year is calculated Nov - October.  Could have issues with this, but move forward for now.  Can be changed later.  
```

## bioclim water year calculations 
#from Brandie's Climate_PCAs_AllYear.Rmd
```{r}
bioclim_allyears_prep <- flint_all_year_wtr_yr %>% 
  rename(tmin=tmn, tmax=tmx, year_cal=year, year=wtr_yr) %>% #rename columns to match what calc_biovars expects, also make sure it uses water year
   arrange(parent.pop, year, months_wtryr) 
###IMPORTANT ### these annyual calcs are in order of the water year months, NOT the calendar year.  These can be recalculated to be the 
#calendar year, but this seems to match that framework better

bioclim_all_years <- tibble(parent.pop = NA, year = NA, bio1=NA, bio2=NA, bio4=NA, bio7=NA, bio8=NA, bio9=NA, bio12=NA, bio15=NA, bio18=NA, bio19=NA) #blank tibble to bind calculations to
bioclim_all_years

popids <- unique(bioclim_allyears_prep$parent.pop) #list of pop ids for for loop 
years <- unique(bioclim_allyears_prep$year)

for(i in 1:length(popids)){
    for(j in 1:length(years)) {
      usedat <- bioclim_allyears_prep %>% filter(parent.pop == popids[i] & year == years[j]) %>% arrange(months_wtryr)
      A <- cbind.data.frame(parent.pop = popids[i], calc_biovars(usedat))
      bioclim_all_years <- bind_rows(bioclim_all_years, A)
    }
}

bioclim_all_years = drop_na(bioclim_all_years)
summary(bioclim_all_years)

```


```{r}
bioclim_all_years_final <- bioclim_all_years %>% 
  select(parent.pop, year, ann_tmean=bio1, mean_diurnal_range=bio2, 
         temp_seasonality=bio4, temp_ann_range=bio7, tmean_wettest_quarter=bio8,
         tmean_driest_quarter=bio9, ann_ppt=bio12, ppt_seasonality=bio15,
         ppt_warmest_quarter=bio18, ppt_coldest_quarter=bio19) 
head(bioclim_all_years_final)
summary(bioclim_all_years_final)
```

##growing season calculations
Can't caluclate with the function in QBMS for calculating it because I only want it for the growth season, which for most populations is less than 12 months. 
https://search.r-project.org/CRAN/refmans/QBMS/html/calc_biovars.html  adapted from Brandie's BioClim_Growth_Season.Rmd

#### Prep

###JENNY START HERE: NEED TO NARROW TO GROWING SEASON MONTHS ####
Check Flint_Growth_Season.Rmd

Calculating average temp and diurnal range for each month 
```{r}
flint_all_year_wtr_yr <- flint_all_year_wtr_yr %>% 
  mutate(tavg = (tmn + tmx)/2, t_diurnal = (tmx-tmn))
```

Calculating wettest, driest, warmest, and coldest months 

```{r}
recent_wettest_month <- flint_all_year_wtr_yr %>%  #there's one wettest month per pop/year
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  slice_max(ppt)

recent_driest_month <- flint_all_year_wtr_yr %>%  #there's more than one driest month for some pops and years 
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  slice_min(ppt)

recent_warmest_month <- flint_all_year_wtr_yr %>% #there's more than one warmest month for 1 pop/year
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  slice_max(tavg)

recent_coldest_month <- flint_all_year_wtr_yr %>% #there's one coldest month per pop/year
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  slice_min(tavg)
```

Bio 1, 2, 4, 7, 12, 15
```{r}
bioclim_growingseason_calc <- flint_all_year_wtr_yr %>% 
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  summarise(ann_tmean=mean(tavg),  #Bio1 - Annual Mean Temperature
            mean_diurnal_range=mean(t_diurnal), #Bio2 - Mean Diurnal Range
            temp_seasonality=sd(tavg), #Bio4 - Temperature Seasonality
            temp_ann_range=(max(tmx))-(min(tmn)), #bio7 - temp annual range
            ann_ppt=sum(ppt), #bio12 - annual precip
            ppt_seasonality=cv(ppt+1)) #bio15 - Precipitation Seasonality (+1 to avoid strange CVs for areas where mean rainfaill is < 1)
bioclim_growingseason_calc
```

Bio 8(Q), 9(Q), 18(Q), 19(Q)
```{r}
#bio8 = tmean_wettest_month
bio8_recent <- recent_wettest_month %>% 
  dplyr::select(parent.pop, elevation.group, elev_m, year, tmean_wettest_month=tavg)

#bio9 = tmean_driest_month
bio9_recent <- recent_driest_month %>% 
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  summarise(tmean_driest_month=mean(tavg)) #taking the average b/c some years where there are multiple driest months 

bio8_9_recent <- full_join(bio8_recent, bio9_recent)

#bio18 = ppt_warmest_month
bio18_recent <- recent_warmest_month %>% 
  group_by(parent.pop, elevation.group, elev_m, year) %>% 
  summarise(ppt_warmest_month=mean(ppt)) #taking the avg b/c more than one warmest month for one pop/year

#bio19 = ppt_coldest_month
bio19_recent <- recent_wettest_month %>% 
  dplyr::select(parent.pop, elevation.group, elev_m, year, ppt_coldest_month=ppt)

bio18_19_recent <- full_join(bio18_recent, bio19_recent)

all_periods_recent <- full_join(bio8_9_recent, bio18_19_recent)
```

Merge all bioclims
```{r}
bioclim_recent <- full_join(bioclim_recent_calc, all_periods_recent)
summary(bioclim_recent)
write_csv(bioclim_recent, "../output/Climate/BioClim_growthseason_Recent.csv")
```


## merge water year and growing season calcs 